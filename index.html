<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>Cumplea√±os del mes</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<style>
/* =====================================================
   PALETA
===================================================== */
:root {
    --bg-main: #7c2cff;
    --card-bg: rgba(255,255,255,0.16);
    --card-border: rgba(255,255,255,0.28);
    --card-subtle: rgba(255,255,255,0.88);
    --primary: #7c2cff;
    --text-main: #111827;
    --text-soft: #6b7280;
    --radius-lg: 24px;
}

/* =====================================================
   BASE
===================================================== */
* { box-sizing: border-box; margin: 0; padding: 0; }

body {
    display: flex;
    justify-content: center;
    background: radial-gradient(circle at top, #a855ff 0%, #4c1d95 35%, #1f102f 100%);
    font-family: 'Inter', sans-serif;
    font-weight: 400;
    letter-spacing: 0.2px;
    color: #f9fafb;
    margin: 0;
    min-height: 100vh;
    overflow-x: hidden;
    -webkit-font-smoothing: antialiased;
    text-rendering: optimizeLegibility;
}

.row-spinner {
    border: 3px solid #e5d9ff;
    border-top: 3px solid #7c3aed;
    width: 16px;
    height: 16px;
    border-radius: 50%;
    animation: spin .7s linear infinite;
    margin-top: 4px;
}


.app {
    width: 100%;
    max-width: 600px; /* o m√°s si quer√©s */
    padding: 24px 16px 40px;
}

/* T√≠tulos en el fondo violeta */
#mainView h1 {
    font-size: 26px;
    font-weight: 600;
    color: #f9fafb;
    margin-bottom: 4px;
}

#mainView p {
    font-size: 14px;
    color: #e5e7eb;
}

/* Texto dentro de cards */
.card h2,
.card p,
.nombre,
.detalle {
    color: var(--text-main);
}

/* Animaciones base */
.fade-in {
    animation: fadeIn 0.35s ease-out;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(8px); }
    to   { opacity: 1; transform: translateY(0); }
}

/* Transici√≥n de lista al cambiar mes */
.list {
    transition: opacity 0.25s ease, transform 0.25s ease;
}

.list.fade-out {
    opacity: 0;
    transform: translateY(6px);
}

/* =====================================================
   BOTONES DE NAVEGACI√ìN
===================================================== */
.nav-btns {
    display: flex;
    justify-content: space-between;
    margin-bottom: 12px;
    gap: 8px;
}

.nav-btns button {
    flex: 1;
    border: none;
    background: radial-gradient(circle at top left, #8b5cf6, #4c1d95);
    color: white;
    padding: 8px 14px;
    border-radius: 999px;
    font-size: 13px;
    cursor: pointer;
    transition: transform 0.16s ease, box-shadow 0.16s ease, opacity 0.16s ease;
    box-shadow: 0 10px 22px rgba(15, 23, 42, 0.35);
}

.nav-btns button:hover {
    transform: translateY(-1px) scale(1.02);
    box-shadow: 0 14px 28px rgba(15, 23, 42, 0.45);
    opacity: 0.95;
}

.nav-btns button:active {
    transform: translateY(1px) scale(0.98);
    box-shadow: 0 6px 14px rgba(15, 23, 42, 0.4);
}




/* =====================================================
   FAB "VOLVER AL MES ACTUAL"
===================================================== */
#btnHoy {
    position: fixed;
    right: 18px;
    bottom: 20px;
    width: 52px;
    height: 52px;
    border-radius: 999px;
    border: none;
    background: radial-gradient(circle at top left, #a855f7, #4338ca);
    color: #f9fafb;
    font-size: 11px;
    font-weight: 600;
    cursor: pointer;
    box-shadow: 0 16px 40px rgba(15, 23, 42, 0.6);
    display: none;
    align-items: center;
    justify-content: center;
    text-align: center;
    padding: 6px;
    line-height: 1.1;
    z-index: 1500;
    transition: transform 0.18s ease, opacity 0.18s ease, box-shadow 0.18s ease;
}

#btnHoy.show {
    display: flex;
    opacity: 1;
    transform: translateY(0);
}

#btnHoy:hover {
    transform: translateY(-2px) scale(1.03);
    box-shadow: 0 18px 44px rgba(15, 23, 42, 0.7);
}

#btnHoy:active {
    transform: translateY(1px) scale(0.97);
}

/* =====================================================
   CARDS (GLASSMORPHISM)
===================================================== */
.card {
    background: var(--card-bg);
    border-radius: 32px;
    padding: 18px 16px 16px;
    box-shadow: 0 18px 48px rgba(15, 23, 42, 0.55);
    border: 1px solid var(--card-border);
    backdrop-filter: blur(18px);
    -webkit-backdrop-filter: blur(18px);
}

.header-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
}

.header-row h2 {
    font-size: 18px;
    font-weight: 600;
}

.badge-month {
    font-size: 12px;
    padding: 4px 10px;
    border-radius: 999px;
    background: linear-gradient(135deg, #f97316, #fb7185);
    color: white;
    font-weight: 500;
}

/* =====================================================
   LISTA Y PERSONAS
===================================================== */
.list {
    display: flex;
    flex-direction: column;
    gap: 10px;
    max-height: 60vh;
    overflow-y: auto;
    padding-right: 2px;
}

.person {
    background: var(--card-subtle);
    border-radius: 18px;
    padding: 10px 11px;
    display: flex;
    gap: 10px;
    align-items: center;
    cursor: pointer;
    transition: transform 0.15s ease, box-shadow 0.15s ease, background 0.15s ease;
    color: var(--text-main);
}

.person:hover {
    background: #f3e8ff;
    box-shadow: 0 10px 24px rgba(124, 58, 237, 0.45);
    transform: translateY(-2px);
}

.person:active {
    transform: translateY(1px) scale(0.99);
    box-shadow: 0 5px 14px rgba(124, 58, 237, 0.5);
}

.avatar {
    width: 38px;
    height: 38px;
    border-radius: 16px;
    background: linear-gradient(135deg, #a855f7, #ec4899);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 18px;
    font-weight: 700;
    flex-shrink: 0;
}

.info { flex: 1; min-width: 0; }

.nombre {
    font-size: 15px;
    font-weight: 600;
    margin-bottom: 2px;
}

.detalle {
    font-size: 12px;
    color: var(--text-soft);
}


.header-top {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 8px;
    margin-bottom: 4px;
}

.info-btn {
    width: 28px;
    height: 28px;
    border-radius: 999px;
    border: none;
    background: rgba(255,255,255,0.16);
    color: #f9fafb;
    font-weight: 600;
    cursor: pointer;
    font-size: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 6px 14px rgba(15,23,42,0.45);
    transition: transform 0.15s ease, box-shadow 0.15s ease, background 0.15s ease;
}

.info-btn:hover {
    background: rgba(255,255,255,0.24);
    transform: translateY(-1px);
    box-shadow: 0 10px 20px rgba(15,23,42,0.6);
}

/* MODAL INFO */
.info-modal {
    position: fixed;
    inset: 0;
    background: rgba(15,23,42,0.55);
    backdrop-filter: blur(4px);
    display: none;            /* se muestra por JS */
    align-items: center;
    justify-content: center;
    z-index: 2500;
}

.info-card {
    background: #ffffff;
    border-radius: 20px;
    padding: 18px 18px 14px;
    max-width: 320px;
    width: 90%;
    box-shadow: 0 20px 50px rgba(15,23,42,0.55);
    font-family: 'Inter', sans-serif;
    color: #111827;
}

.info-card h2 {
    font-size: 18px;
    margin-bottom: 10px;
}

.info-card ol {
    margin-left: 18px;
    font-size: 14px;
    color: #374151;
}

.info-card li {
    margin-bottom: 4px;
}

.info-close {
    margin-top: 12px;
    width: 100%;
    border: none;
    border-radius: 999px;
    padding: 8px 12px;
    background: linear-gradient(135deg, #7c3aed, #4f46e5);
    color: #fff;
    font-weight: 600;
    font-size: 14px;
    cursor: pointer;
}


/* =====================================================
   ALIAS / SUBIR CONSTANCIA
===================================================== */
.alias-btn,
.btn-upload {
    background: linear-gradient(135deg, #7c3aed, #4f46e5);
    border-radius: 999px;
    color: white;
    padding: 6px 12px;
    cursor: pointer;
    border: none;
    font-size: 12px;
    font-weight: 600;
    letter-spacing: 0.25px;
    box-shadow: 0 10px 24px rgba(37, 99, 235, 0.5);
    transition: transform 0.16s ease, box-shadow 0.16s ease, opacity 0.16s ease;
}

.alias-btn {
    padding: 6px 14px;
    animation: aliasPulse 2s infinite alternate;
}

.alias-btn:hover,
.btn-upload:hover {
    transform: translateY(-1px) scale(1.03);
    box-shadow: 0 14px 30px rgba(37, 99, 235, 0.65);
    opacity: 0.96;
}

.alias-btn:active,
.btn-upload:active {
    transform: translateY(1px) scale(0.97);
    box-shadow: 0 8px 18px rgba(37, 99, 235, 0.6);
}

@keyframes aliasPulse {
    0% { transform: scale(1); }
    100% { transform: scale(1.05); }
}

.status {
    font-size: 11px;
    margin-top: 4px;
}

/* Inputs ocultos */
input[type="file"] { display: none; }

/* =====================================================
   LOADING OVERLAY GLOBAL
===================================================== */
#loadingOverlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: radial-gradient(circle at top, rgba(88,28,135,0.5), rgba(17,24,39,0.9));
    backdrop-filter: blur(4px);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 2000;
}

.loader {
    border: 6px solid #d1c4ff;
    border-top: 6px solid #7c3aed;
    border-radius: 50%;
    width: 55px;
    height: 55px;
    animation: spin .8s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* =====================================================
   LOADING DETALLE (spinner)
===================================================== */
#detalleLoading {
    width: 100%;
    padding: 20px 0;
    display: none;
    justify-content: center;
}

.detalle-spinner {
    border: 5px solid #ddd2ff;
    border-top: 5px solid #7c3aed;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    animation: spin .8s linear infinite;
}

/* =====================================================
   SKELETON LOADERS
===================================================== */
.skeleton {
    background: linear-gradient(90deg, #e6dbff 0%, #f2ecff 50%, #e6dbff 100%);
    background-size: 200% 100%;
    animation: skeletonAnim 1.2s infinite;
    border-radius: 16px;
}

@keyframes skeletonAnim {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
}

.skel-item {
    height: 60px;
}

/* Responsive */
@media (max-width: 480px) {
    .card { border-radius: 26px; }
}

/* BOT√ìN FLOTANTE M√ÅS INFO */
.floating-info-btn {
    position: fixed;
    right: 16px;
    bottom: 16px;
    z-index: 2000;
    background: linear-gradient(135deg, #8b5cf6, #4c1d95);
    color: white;
    border: none;
    padding: 10px 16px;
    font-size: 14px;
    font-weight: 600;
    border-radius: 14px;
    cursor: pointer;
    box-shadow: 0 12px 30px rgba(0,0,0,0.35);
    display: flex;
    align-items: center;
    gap: 6px;
    transition: transform 0.18s ease, box-shadow 0.18s ease, opacity 0.18s ease;
}

.floating-info-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 16px 40px rgba(0,0,0,0.45);
}

.floating-info-btn:active {
    transform: translateY(1px);
}

</style>
</head>

<body>





<!-- OVERLAY LOADING GLOBAL -->
<div id="loadingOverlay">
    <div class="loader"></div>
</div>

<!-- MODAL INFO -->
<!-- MODAL INFO -->
<div id="infoModal" class="info-modal">
    <div class="info-card">
        <h2>¬øC√≥mo funciona?</h2>
        <ol>
            <li>Entr√° al cumplea√±os.</li>
            <li>Copi√° el alias.</li>
            <li>Hac√© la transferencia.</li>
            <li>Sub√≠ la imagen de la transferencia.</li>
            <li>La imagen llega directo al titular del alias por email.</li>
        </ol>
        <p style="margin-top:10px;font-size:13px;color:#6b7280;">
            Listo: f√°cil, simple y √°gil üíú
        </p>
        <button id="infoClose" class="info-close">Entendido</button>
    </div>
</div>


<!-- FAB VOLVER AL MES ACTUAL -->
<button id="btnHoy">Mes<br>actual</button>



<!-- FAB VOLVER AL MES ACTUAL -->
<button id="btnHoy">Mes<br>actual</button>

<!-- ============================
     VISTA PRINCIPAL
============================ -->
<div class="app fade-in" id="mainView">
    <h1>Cumples del mes üéâ  </h1>
    <p style="font-size:14px; color:#e5e7eb;">
    Dej√° de anotar los cumples en la heladera‚Ä¶ mantenete al d√≠a con las transferencias de los regalos üéÅ
</p>
    <p id="montoMensual" style="
    font-size:14px;
    margin-top:6px;
margin-bottom:16px;   /* üëà ESPACIO NUEVO */
    color:#f9fafb;
    font-weight:500;
    background: rgba(255,255,255,0.12);
    padding:8px 12px;
    border-radius:12px;
    backdrop-filter: blur(6px);
    ">
    Cargando monto mensual...
</p>

    <div class="nav-btns">
        <button id="btnPrev">‚Üê Mes anterior</button>
        <button id="btnNext">Mes actual</button>

    </div>

    <div class="card fade-in">
        <div class="header-row">
            <h2></h2>
            <div class="badge-month" id="badgeMes"></div>
        </div>

        <div id="lista" class="list"></div>
    </div>
</div>

<!-- ============================
     VISTA DETALLE
============================ -->
<div class="app fade-in" id="detalle" style="display:none;">
    <button id="volver"
        style="background:none;border:none;color:white;font-size:16px;margin-bottom:10px;cursor:pointer;">
        ‚Üê Volver
    </button>

    <div class="card fade-in">
        <h2 id="detalleTitulo"></h2>
        <p id="detalleFecha" style="color:#000;font-size:14px;margin-bottom:10px;"></p>

<!-- CARD DATOS DEL TITULAR DEL ALIAS -->
<div id="cardAlias" class="card-alias" style="margin-bottom:16px;display:none;">
    <h3 style="color:#111;">Datos del titular del alias</h3>

    <div class="alias-row" style="margin-top:6px; display:flex; align-items:center; gap:10px;">
        <span style="color:#111; font-weight:600;">Alias:</span>
        <span id="aliasValue" 
              style="background:#f5f0ff;padding:6px 12px;border-radius:8px;color:#111;">
        </span>

        <button class="copy-btn" onclick="copiarAlias()"
            style="background:#7c2cff;border:none;padding:6px 14px;border-radius:10px;color:#fff;cursor:pointer;">
            Copiar
        </button>
    </div>

<!-- EMAIL DE ENV√çO AUTOM√ÅTICO -->
<div id="emailDestino" 
     style="
        margin-top:14px;
        background: rgba(255,255,255,0.75);
        padding:10px 12px;
        border-radius:12px;
        color:#111;
        font-size:14px;
        line-height:1.3;
     ">
    Los comprobantes ser√°n enviados autom√°ticamente a:<br>
    <span id="emailValue" style="font-weight:600;color:#4c1d95;"></span>
</div>

</div>

        <div id="detalleLoading">
            <div class="detalle-spinner"></div>
        </div>


<input 
    id="buscadorDetalle" 
    type="text" 
    placeholder="Buscar familia de..."
    style="
        width:100%;
        padding:10px 14px;
        margin-bottom:12px;
        border-radius:12px;
        border:none;
        outline:none;
        font-size:14px;
        background: rgba(255,255,255,0.8);
        color:#111;
    "
>

        <div id="listaCurso" class="list"></div>
<p id="totalAPagar" style="
    margin-top:16px;
    font-size:15px;
    font-weight:600;
    color:#111;
    background:rgba(255,255,255,0.7);
    padding:10px 14px;
    border-radius:12px;
    display:none;
">
</p>

    </div>
</div>


<button id="floatingInfoBtn" class="floating-info-btn">‚ÑπÔ∏è M√°s info</button>
<!-- =====================================================
     SCRIPT
===================================================== -->
<script>
function showLoading() {
    document.getElementById("loadingOverlay").style.display = "flex";
}
function hideLoading() {
    document.getElementById("loadingOverlay").style.display = "none";
}

const WEB_APP_URL =
 "https://script.google.com/macros/s/AKfycbya1fTPWQvLrc5wJFb9x79Huq-sfim0RMzF-mWIRnE6Wl5pj3vgzHW0SCA905TmMKnT/exec";

const meses = [
    "Enero","Febrero","Marzo","Abril","Mayo","Junio",
    "Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"
];

let montoMensualValor = 0;
let hoy   = new Date();
let hoyMes  = hoy.getMonth() + 1;
let hoyAnio = hoy.getFullYear();

let mesActualEnPantalla  = hoyMes;
let anioActualEnPantalla = hoyAnio;

/* =====================================================
   FAB VISIBILIDAD
===================================================== */
function updateFabHoy() {
    const fab = document.getElementById("btnHoy");
    if (mesActualEnPantalla === hoyMes && anioActualEnPantalla === hoyAnio) {
        fab.classList.remove("show");
        fab.style.display = "none";
    } else {
        fab.style.display = "flex";
        // timeout corto para que la transici√≥n se vea
        setTimeout(() => fab.classList.add("show"), 10);
    }
}

document.getElementById("btnHoy").onclick = () => {
    mesActualEnPantalla  = hoyMes;
    anioActualEnPantalla = hoyAnio;
    cargarCumples();
};

/* =====================================================
   NAVEGACI√ìN MESES
===================================================== */
document.getElementById("btnPrev").onclick = () => {
    mesActualEnPantalla--;
    if (mesActualEnPantalla === 0) {
        mesActualEnPantalla = 12;
        anioActualEnPantalla--;
    }
    cargarCumples();
};

document.getElementById("btnNext").onclick = () => {
    mesActualEnPantalla = hoyMes;
    anioActualEnPantalla = hoyAnio;
    cargarCumples();
};


/* =====================================================
   SKELETON (lista principal)
===================================================== */
function renderSkeletonLista() {
    const cont = document.getElementById("lista");
    cont.innerHTML = "";
    for (let i = 0; i < 6; i++) {
        const sk = document.createElement("div");
        sk.className = "skeleton skel-item";
        cont.appendChild(sk);
    }
}




function cargarMontoMensual() {
    fetch(`${WEB_APP_URL}?action=parametro&key=monto_mensual`)
        .then(async r => {
    const text = await r.text();
    try {
        return JSON.parse(text);
    } catch(e) {
        return { success: true }; // fallback
    }
})
        .then(data => {
            if (data && data.value) {
                montoMensualValor = Number(data.value);
                document.getElementById("montoMensual").textContent =
                    `El monto a transferir para cada cumplea√±os es de: $${data.value}`;
            } else {
                document.getElementById("montoMensual").textContent =
                    "No se pudo cargar el monto mensual.";
            }
        })
        .catch(() => {
            document.getElementById("montoMensual").textContent =
                "Error cargando el monto mensual.";
        });
}


/* =====================================================
   CARGAR CUMPLES
===================================================== */
function cargarCumples() {
    showLoading();
    updateFabHoy();

    const lista = document.getElementById("lista");
    lista.classList.add("fade-out");
    renderSkeletonLista();

    document.getElementById("badgeMes").textContent =
        meses[mesActualEnPantalla - 1] + " " + anioActualEnPantalla;

    fetch(`${WEB_APP_URL}?action=list&mes=${mesActualEnPantalla}&anio=${anioActualEnPantalla}`)
        .then(r => r.json())
        .then(async data => {

    // Para cada cumple, pedimos su detalle con totales
    const dataConTotales = await Promise.all(
        data.map(async cumple => {
            const detalle = await fetch(`${WEB_APP_URL}?action=curso&id_cumple=${cumple.id_cumple}`)
                                  .then(r => r.json());

            return {
                ...cumple,
                total_familias: detalle.total_familias,
                pagos_realizados: detalle.pagos_realizados
            };
        })
    );

    renderLista(dataConTotales);
    lista.classList.remove("fade-out");
    hideLoading();
})

        .catch(() => {
            lista.classList.remove("fade-out");
            hideLoading();
        });
}

/* =====================================================
   LISTA PRINCIPAL
===================================================== */
function renderLista(personas) {
    const cont = document.getElementById("lista");
    cont.innerHTML = "";

    if (!personas || personas.length === 0) {
        cont.innerHTML = "<p class='detalle'>No hay cumplea√±os para este mes.</p>";
        return;
    }

    personas.forEach(p => {
        const card = document.createElement("div");
        card.className = "person fade-in";
        card.onclick = () => abrirDetalle(p);

        const avatar = document.createElement("div");
        avatar.className = "avatar";
        avatar.textContent = p.nombre.charAt(0).toUpperCase();

        const info = document.createElement("div");
        info.className = "info";
        const total = p.total_familias ?? 0;
const pagos = p.pagos_realizados ?? 0;
const pct = total > 0 ? Math.round((pagos / total) * 100) : 0;

// Caritas
let emoji = "üò∞";
if (pct > 90) emoji = "üéâ";
else if (pct > 60) emoji = "üòÑ";
else if (pct > 25) emoji = "üôÇ";

// Mensajes motivacionales
let mensaje = "Vamos que reci√©n arrancamos üí™";
if (pct > 25)  mensaje = "Se siente el impulso del grupo üöÄ";
if (pct > 60)  mensaje = "¬°Ya falta poco! Gracias por sumarse üôå";
if (pct > 90)  mensaje = "¬°Este cumple explota! üéâ Gracias a todos";

// === Calcular diferencia de d√≠as ===
const [dia, mes, anio] = p.fecha_cumple.split("/").map(Number);
const fechaCumple = new Date(anio, mes - 1, dia);
const hoy2 = new Date();

hoy2.setHours(0,0,0,0);
fechaCumple.setHours(0,0,0,0);

const diffMs = fechaCumple - hoy2;
const diffDias = Math.floor(diffMs / (1000 * 60 * 60 * 24));

let mensajeDias = "";

if (diffDias > 0) {
    mensajeDias = `‚è≥ Te quedan ${diffDias} d√≠as, no cuelgues`;
} 
else if (diffDias === 0) {
    mensajeDias = `üî• ¬°Es hoy, dale, no cuelgues!`;
} 
else {
    mensajeDias = `üìÖ El cumple ya pas√≥, pero transfer√≠ igual si no lo hiciste`;
}


info.innerHTML = `
    <div class="nombre">${p.nombre} <span style="font-size:18px;">${emoji}</span></div>

    <div class="detalle">
        üéÇ ${p.fecha_cumple}
        <span style="font-size:11px; margin-left:8px; color:#4c1d95;">
            ${mensajeDias}
        </span>
    </div>

    <div class="detalle" style="font-size:11px;opacity:0.8;">
        ${pagos} de ${total} transferencias
    </div>

    <div class="detalle" style="font-size:12px;margin-top:4px;font-weight:500;color:#4c1d95;">
        ${mensaje}
    </div>
`;


        card.appendChild(avatar);
        card.appendChild(info);
        cont.appendChild(card);
    });
}

/* =====================================================
   DETALLE
===================================================== */
function abrirDetalle(cumple) {
document.getElementById("buscadorDetalle").value = "";
    window.aliasActual = cumple.alias;
    window.cumpleNombreCompleto = cumple.nombre;

    document.getElementById("mainView").style.display = "none";
    document.getElementById("detalle").style.display = "block";

    document.getElementById("detalleTitulo").textContent = cumple.nombre;

    document.getElementById("detalleFecha").innerHTML = `
        üéÇ ${cumple.fecha_cumple} ‚Ä¢ 
        
    `;
// Mostrar card de alias
document.getElementById("cardAlias").style.display = "block";
document.getElementById("aliasValue").innerText = cumple.alias;
document.getElementById("emailValue").innerText = cumple.email_comprobante || "No informado";
document.getElementById("emailDestino").style.display = "block";

    document.getElementById("listaCurso").style.display = "none";
    document.getElementById("detalleLoading").style.display = "flex";

    fetch(`${WEB_APP_URL}?action=curso&id_cumple=${cumple.id_cumple}`)
        .then(r => r.json())
        .then(data => {
// Guardamos los totales dentro del cumple
            cumple.total_familias   = data.total_familias;
            cumple.pagos_realizados = data.pagos_realizados;
            renderCurso(data, cumple);
            document.getElementById("detalleLoading").style.display = "none";
            document.getElementById("listaCurso").style.display = "flex";
        });
}

document.getElementById("volver").onclick = () => {

    // Mostrar vista principal
    document.getElementById("mainView").style.display = "block";
    document.getElementById("detalle").style.display = "none";

    // üî• Volver a cargar cumplea√±os para actualizar porcentajes
    cargarCumples();
};


/* =====================================================
   CURSO + HISTORIAL
===================================================== */
function renderCurso(data, cumple) {
    const listado   = data.curso;
    const historial = data.historial;

    const cont = document.getElementById("listaCurso");
    cont.innerHTML = "";

    listado.forEach((alumno, index) => {

        const yaPago = historial.some(h =>
            h.id_cumple == cumple.id_cumple &&
            h.id_curso == alumno.id_curso
        );

        const row = document.createElement("div");
        row.className = "person fade-in";

        const avatar = document.createElement("div");
        avatar.className = "avatar";
        avatar.textContent = alumno.nombre.charAt(0).toUpperCase();

        const info = document.createElement("div");
        info.className = "info";
        info.innerHTML = `
            <div class="nombre">${alumno.nombre} ${alumno.apellido}</div>
            <div class="detalle">${alumno.estado}</div>
        `;

        const upload = document.createElement("div");
        upload.style.display = "flex";
        upload.style.flexDirection = "column";
        upload.style.alignItems = "flex-end";

        const status = document.createElement("div");
        status.className = "status";

        if (yaPago) {
            status.textContent = "Imagen de comprobante cargada ‚úì";
            status.style.color = "#16a34a";
            status.style.fontWeight = "bold";
            upload.appendChild(status);
        } else {
            const inp = document.createElement("input");
            inp.type  = "file";
            inp.accept = "image/*";
            inp.id = "file_" + index;

            const btn = document.createElement("button");
            btn.className = "btn-upload";
            btn.textContent = "Subir captura de comprobante";
            btn.onclick = e => { e.stopPropagation(); inp.click(); };

            inp.addEventListener("change", e => {
                if (!e.target.files.length) return;

                const file = e.target.files[0];
                const ext  = file.name.split(".").pop();

                const year  = anioActualEnPantalla;
                const month = mesActualEnPantalla;

                const alumnoBase = `${alumno.nombre}_${alumno.apellido}`.replace(/[^a-zA-Z0-9]/g, "_");
                const cumpleBase = cumple.nombre.replace(/[^a-zA-Z0-9]/g, "_");

                const fileName = `${cumpleBase}__${alumnoBase}_${month}_${year}_constancia_pago.${ext}`;

                status.innerHTML = `<div class="row-spinner"></div>`;


                subirArchivoCurso(file, fileName, month, year, status, cumple.id_cumple, alumno.id_curso);
            });

            upload.appendChild(btn);
            upload.appendChild(status);
            row.appendChild(inp);
        }

        row.appendChild(avatar);
        row.appendChild(info);
        row.appendChild(upload);

        cont.appendChild(row);
    });
// === Calcular total transferido para este cumple ===
const countPagos = historial.filter(h =>
    h.id_cumple == cumple.id_cumple
).length;

const total = countPagos * montoMensualValor;


}

/* =====================================================
   SUBIDA CONSTANCIA
===================================================== */
function subirArchivoCurso(file, fileName, month, year, statusEl, id_cumple, id_curso) {
    const reader = new FileReader();
    reader.onload = e => {
        const base64 = e.target.result.split(",")[1];

        fetch(WEB_APP_URL, {
            method: "POST",
            body: JSON.stringify({
                fileName,
                mimeType: file.type,
                base64,
                month,
                year,
                id_cumple,
                id_curso
            })
        })
        .then(r => r.json())
        .then(resp => {
            if (resp.success) {
                statusEl.textContent = "Imagen de comprobante cargada ‚úì";
                statusEl.style.color = "#16a34a";
                statusEl.style.fontWeight = "bold";

        // üî• OCULTAR BOT√ìN APENAS SUBE OK
        const btn = statusEl.previousSibling; // el bot√≥n est√° justo antes del status
        if (btn && btn.tagName === "BUTTON") {
            btn.style.display = "none";
        }

            } else {
                statusEl.textContent = "Error al subir";
                statusEl.style.color = "#dc2626";
            }
        })
        .catch(() => {
            statusEl.textContent = "Error de red";
            statusEl.style.color = "#dc2626";
        });
    };

    reader.readAsDataURL(file);
}

/* =====================================================
   COPIAR ALIAS
===================================================== */
document.addEventListener("click", e => {
    if (e.target.id === "aliasCopy") {
        navigator.clipboard.writeText(window.aliasActual)
            .then(() => {
                e.target.textContent = "Alias copiado ‚úì";
                setTimeout(() => e.target.textContent = "Copiar alias", 1500);
            });
    }
});

/* =====================================================
   INICIO
===================================================== */
cargarCumples();
cargarMontoMensual();

// =====================================================
// BUSCADOR EN DETALLE
// =====================================================
document.getElementById("buscadorDetalle").addEventListener("input", function() {
    const texto = this.value.toLowerCase();
    const items = document.querySelectorAll("#listaCurso .person");

    items.forEach(item => {
        const nombre = item.innerText.toLowerCase();
        item.style.display = nombre.includes(texto) ? "flex" : "none";
    });
});


function copiarAlias() {
    const alias = document.getElementById("aliasValue").innerText;
    const btn = document.querySelector(".copy-btn");

    navigator.clipboard.writeText(alias).then(() => {
        // Cambiar texto del bot√≥n
        btn.textContent = "Copiado ‚úì";
        btn.style.background = "#16a34a";   // verde suave "success"
        
        // Volver al estado original luego de 2 segundos
        setTimeout(() => {
            btn.textContent = "Copiar";
            btn.style.background = "#7c2cff"; // violeta original
        }, 2000);
    });
}

// =====================================================
// MODAL INFO
// =====================================================
const infoModal       = document.getElementById("infoModal");
const infoClose       = document.getElementById("infoClose");
const floatingInfoBtn = document.getElementById("floatingInfoBtn");

// Abrir modal desde el bot√≥n flotante
if (floatingInfoBtn) {
    floatingInfoBtn.addEventListener("click", () => {
        infoModal.style.display = "flex";
    });
}

// Cerrar con el bot√≥n "Entendido"
if (infoClose) {
    infoClose.addEventListener("click", () => {
        infoModal.style.display = "none";
    });
}

// Cerrar haciendo click afuera de la tarjeta
infoModal.addEventListener("click", (e) => {
    if (e.target === infoModal) {
        infoModal.style.display = "none";
    }
});



</script>


</body>
</html>